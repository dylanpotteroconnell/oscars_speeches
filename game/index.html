<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Oscar Speech Trivia</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: Georgia, 'Times New Roman', serif;
    background: #121212;
    color: #d0d0d0;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .container {
    max-width: 700px;
    width: 100%;
    padding: 20px;
  }

  header {
    text-align: center;
    padding: 30px 0 20px;
  }

  header h1 {
    font-size: 1.8rem;
    color: #d4af37;
    letter-spacing: 1px;
  }

  .score-bar {
    display: flex;
    justify-content: center;
    gap: 30px;
    margin-top: 10px;
    font-size: 0.95rem;
    color: #aaa;
  }

  .score-bar span { color: #d4af37; font-weight: bold; }

  .card {
    background: #1a1a1a;
    border: 1px solid #2a2418;
    border-radius: 12px;
    padding: 28px;
    margin: 16px 0;
    box-shadow: 0 2px 12px rgba(212, 175, 55, 0.08);
  }

  .card-label {
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 2px;
    color: #d4af37;
    margin-bottom: 12px;
  }

  .snippet {
    font-size: 1.1rem;
    line-height: 1.7;
    color: #ddd;
    white-space: pre-wrap;
  }

  .gold-divider {
    border: none;
    border-top: 1px solid rgba(212, 175, 55, 0.25);
    margin: 20px 0;
  }

  .guess-form {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin: 16px 0;
  }

  .guess-form input,
  .guess-form select {
    padding: 12px 16px;
    border: 1px solid #333;
    border-radius: 8px;
    background: #181818;
    color: #d0d0d0;
    font-size: 1rem;
    font-family: inherit;
  }

  .guess-form input:focus,
  .guess-form select:focus {
    outline: none;
    border-color: #d4af37;
  }

  .btn-row {
    display: flex;
    gap: 10px;
  }

  button {
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    font-size: 1rem;
    font-family: inherit;
    cursor: pointer;
    transition: background 0.2s;
  }

  .btn-primary {
    background: #d4af37;
    color: #1a1a2e;
    font-weight: bold;
    flex: 1;
  }

  .btn-primary:hover { background: #e6c347; }
  .btn-primary:disabled { background: #666; cursor: not-allowed; }

  .btn-secondary {
    background: #2a2a2a;
    color: #c4a035;
  }

  .btn-secondary:hover { background: #383838; }
  .btn-secondary:disabled { background: #333; color: #666; cursor: not-allowed; }

  .btn-give-up {
    background: transparent;
    color: #666;
    font-size: 0.85rem;
    padding: 8px 12px;
    margin-left: auto;
    border: 1px solid #444;
    border-radius: 8px;
  }

  .btn-give-up:hover { color: #999; border-color: #666; }

  .feedback {
    padding: 14px 18px;
    border-radius: 8px;
    margin: 12px 0;
    font-size: 0.95rem;
  }

  .feedback.correct {
    background: #1b4332;
    border: 1px solid #2d6a4f;
    color: #95d5b2;
  }

  .feedback.wrong {
    background: #3d1f1f;
    border: 1px solid #6b2d2d;
    color: #e8a0a0;
  }

  .feedback.hint {
    background: #2e2a1a;
    border: 1px solid #5a4e2a;
    color: #e6d48e;
  }

  .reveal {
    margin-top: 16px;
  }

  .reveal h3 {
    color: #d4af37;
    margin-bottom: 8px;
    font-size: 1rem;
  }

  .reveal .answer-info {
    font-size: 1.05rem;
    margin-bottom: 16px;
    color: #95d5b2;
  }

  .reveal .full-speech {
    font-size: 0.9rem;
    line-height: 1.6;
    color: #bbb;
    white-space: pre-wrap;
    max-height: 300px;
    overflow-y: auto;
    padding: 16px;
    background: #111;
    border-radius: 8px;
  }

  .highlight {
    background: #c4a03522;
    color: #c4a035;
    padding: 1px 3px;
    border-radius: 3px;
  }

  .summary {
    text-align: center;
    padding: 40px 0;
  }

  .summary h2 {
    color: #d4af37;
    font-size: 1.6rem;
    margin-bottom: 20px;
  }

  .summary .final-score {
    font-size: 3rem;
    color: #d4af37;
    font-weight: bold;
  }

  .summary .breakdown {
    margin-top: 20px;
    text-align: left;
  }

  .summary .breakdown div {
    padding: 8px 0;
    border-bottom: 1px solid #333;
    display: flex;
    justify-content: space-between;
  }

  .report-link {
    display: inline-block;
    margin-top: 12px;
    font-size: 0.75rem;
    color: #666;
    text-decoration: none;
  }

  .report-link:hover { color: #999; text-decoration: underline; }

  .guesses-left {
    text-align: center;
    font-size: 0.85rem;
    color: #888;
    margin-top: 4px;
  }

  #loading {
    text-align: center;
    padding: 60px 0;
    color: #888;
    font-size: 1.1rem;
  }

  .start-screen {
    text-align: center;
    padding: 20px 0;
  }

  .start-screen h2 {
    color: #d4af37;
    margin-bottom: 20px;
  }

  .start-screen .rules {
    text-align: left;
    background: #1a1a1a;
    border: 1px solid #2a2418;
    border-radius: 12px;
    padding: 24px;
    margin: 20px 0;
    line-height: 1.8;
  }

  .start-screen .rules p {
    margin-bottom: 12px;
  }

  .start-screen .rules p:last-child {
    margin-bottom: 0;
  }
</style>
</head>
<body>

<div class="container">
  <header>
    <h1>Oscar Speech Trivia</h1>
    <div class="score-bar">
      <div>Score: <span id="score">0</span></div>
      <div>Speech: <span id="progress">0 / 0</span></div>
    </div>
  </header>

  <div id="loading">Loading speeches...</div>
  <div id="start" style="display:none"></div>
  <div id="game" style="display:none"></div>
  <div id="summary" style="display:none"></div>
</div>

<script>
(function() {
  let data = null;
  let speeches = [];
  let currentIndex = 0;
  let score = 0;
  let guessesUsed = 0;
  let hintsUsed = 0;
  let hintShown = false;
  let roundOver = false;
  let results = [];

  const MAX_GUESSES = 3;
  const GAME_SIZE = 5;

  function shuffle(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  function calcPoints(correct, hintsUsed, wrongGuesses) {
    if (!correct) return 0;
    // Start at 10, -2 per hint, -2 per wrong guess, minimum 1
    let pts = 10 - (hintsUsed * 2) - (wrongGuesses * 2);
    return Math.max(1, pts);
  }

  function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  function normalizeTitle(s) {
    return s.toLowerCase()
      .replace(/['']/g, '')       // strip apostrophes/curly quotes
      .replace(/[^a-z0-9 ]/g, '') // strip remaining punctuation
      .replace(/^the /, '')        // drop leading "the"
      .replace(/\s+/g, ' ')
      .trim();
  }

  function levenshtein(a, b) {
    const m = a.length, n = b.length;
    const dp = Array.from({length: m + 1}, () => Array(n + 1).fill(0));
    for (let i = 0; i <= m; i++) dp[i][0] = i;
    for (let j = 0; j <= n; j++) dp[0][j] = j;
    for (let i = 1; i <= m; i++) {
      for (let j = 1; j <= n; j++) {
        dp[i][j] = a[i-1] === b[j-1]
          ? dp[i-1][j-1]
          : 1 + Math.min(dp[i-1][j], dp[i][j-1], dp[i-1][j-1]);
      }
    }
    return dp[m][n];
  }

  function titleMatches(input, actual) {
    const a = normalizeTitle(input);
    const b = normalizeTitle(actual);
    if (!a) return false;
    if (a === b) return true;
    const maxDist = b.length < 15 ? 2 : 3;
    return levenshtein(a, b) <= maxDist;
  }

  const FEEDBACK_FORM_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSdiQ6Z-Cj3US8yAkkYhlBTu-Br6OmIL91xrZ75wo6HDFEO53g/viewform?usp=pp_url';

  function feedbackUrl(sp) {
    const speech = `${sp.year} | ${sp.category} | ${sp.film_title} | ${sp.winner_clean}`;
    return `${FEEDBACK_FORM_URL}&entry.952206426=${encodeURIComponent(speech)}`;
  }

  function highlightRedactions(snippetRaw) {
    // Replace [REDACT: text] with highlighted text
    return snippetRaw.replace(/\[REDACT:\s*(.*?)\]/g,
      '<span class="highlight">$1</span>');
  }

  function renderGame() {
    const sp = speeches[currentIndex];
    const guessesRemaining = MAX_GUESSES - guessesUsed;

    let categoryOptions = data.categories.map(c =>
      `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`
    ).join('');

    document.getElementById('game').innerHTML = `
      <div class="card">
        <div class="card-label">Who won this Oscar?</div>
        <div class="snippet">${escapeHtml(sp.snippet_display)}</div>
      </div>

      <hr class="gold-divider">

      <div id="feedback-area"></div>

      <div id="guess-section">
        <div class="guess-form">
          <input type="text" id="movie-input" placeholder="Movie title..." autocomplete="off">
          <select id="category-select">
            <option value="">Select category...</option>
            ${categoryOptions}
          </select>
          <div class="btn-row">
            <button class="btn-primary" id="guess-btn">Guess</button>
            <button class="btn-secondary" id="hint-btn">Hint</button>
            <button class="btn-give-up" id="giveup-btn">Give up</button>
          </div>
        </div>
        <div class="guesses-left">${guessesRemaining} guess${guessesRemaining !== 1 ? 'es' : ''} remaining</div>
      </div>

      <div id="reveal-section" style="display:none"></div>
    `;

    document.getElementById('guess-btn').addEventListener('click', handleGuess);
    document.getElementById('hint-btn').addEventListener('click', handleHint);
    document.getElementById('giveup-btn').addEventListener('click', handleGiveUp);
    document.getElementById('movie-input').addEventListener('keydown', e => {
      if (e.key === 'Enter') handleGuess();
    });

    updateScoreBar();
  }

  function updateScoreBar() {
    document.getElementById('score').textContent = score;
    document.getElementById('progress').textContent =
      `${currentIndex + 1} / ${speeches.length}`;
  }

  function handleGuess() {
    if (roundOver) return;
    const sp = speeches[currentIndex];
    const movieInput = document.getElementById('movie-input').value.trim();
    const categoryInput = document.getElementById('category-select').value;

    if (!movieInput || !categoryInput) {
      showFeedback('Please enter a movie title and select a category.', 'wrong validation');
      return;
    }

    guessesUsed++;

    const movieMatch = titleMatches(movieInput, sp.film_title);
    const categoryMatch = categoryInput === sp.category;

    if (movieMatch && categoryMatch) {
      const wrongGuesses = guessesUsed - 1; // this guess was correct
      const pts = calcPoints(true, hintsUsed, wrongGuesses);
      score += pts;
      results.push({ speech: sp, correct: true, points: pts });
      showFeedback(`Correct! +${pts} points`, 'correct');
      endRound(true);
    } else {
      let msg = '';
      if (!movieMatch && !categoryMatch) msg = 'Wrong movie and category.';
      else if (!movieMatch) msg = 'Wrong movie title.';
      else msg = 'Wrong category.';

      if (guessesUsed >= MAX_GUESSES) {
        results.push({ speech: sp, correct: false, points: 0 });
        showFeedback(`${msg} No guesses left.`, 'wrong');
        endRound(false);
      } else {
        showFeedback(`${msg} ${MAX_GUESSES - guessesUsed} guess${MAX_GUESSES - guessesUsed !== 1 ? 'es' : ''} remaining.`, 'wrong');
        document.querySelector('.guesses-left').textContent =
          `${MAX_GUESSES - guessesUsed} guess${MAX_GUESSES - guessesUsed !== 1 ? 'es' : ''} remaining`;
      }
    }
  }

  function handleHint() {
    if (roundOver) return;
    const sp = speeches[currentIndex];
    const hasPlotHint = sp.plot_hint != null && sp.plot_hint !== '';
    const hasFilmOptions = sp.film_options && sp.film_options.length;

    if (hintsUsed === 0 && hasFilmOptions) {
      // First hint: narrow down to film options
      hintsUsed++;
      const optionsList = sp.film_options.map(f => escapeHtml(f)).join(', ');
      showFeedback(`It's one of: ${optionsList}`, 'hint');
      if (!hasPlotHint) document.getElementById('hint-btn').disabled = true;
    } else if (hasPlotHint) {
      // Second hint (or first if no film options): plot hint
      hintsUsed++;
      showFeedback(`Hint: ${escapeHtml(sp.plot_hint)}`, 'hint');
      document.getElementById('hint-btn').disabled = true;
    } else {
      document.getElementById('hint-btn').disabled = true;
    }
  }

  function handleGiveUp() {
    if (roundOver) return;
    results.push({ speech: speeches[currentIndex], correct: false, points: 0 });
    showFeedback('You gave up.', 'wrong');
    endRound(false);
  }

  function showFeedback(msg, type) {
    const area = document.getElementById('feedback-area');
    if (!type.includes('validation')) {
      area.querySelectorAll('.validation').forEach(el => el.remove());
    }
    area.insertAdjacentHTML('beforeend', `<div class="feedback ${type}">${msg}</div>`);
  }

  function endRound(correct) {
    roundOver = true;
    const sp = speeches[currentIndex];

    document.getElementById('guess-section').style.display = 'none';

    const revealSection = document.getElementById('reveal-section');
    revealSection.style.display = 'block';
    revealSection.innerHTML = `
      <div class="reveal">
        <div class="answer-info">
          <strong>${escapeHtml(sp.film_title)}</strong> (${sp.year}) &mdash;
          ${escapeHtml(sp.winner_clean)}<br>
          ${escapeHtml(sp.category)}
        </div>
        <div class="card">
          <div class="card-label">Unredacted Snippet</div>
          <div class="snippet">${highlightRedactions(sp.golden_snippet)}</div>
        </div>
        <h3>Full Speech</h3>
        <div class="full-speech">${escapeHtml(sp.full_speech_raw)}</div>
        <div style="text-align:center; margin-top:20px">
          <button class="btn-primary" id="next-btn" style="max-width:200px">
            ${currentIndex < speeches.length - 1 ? 'Next Speech' : 'See Results'}
          </button>
          <br>
          <a class="report-link" href="${feedbackUrl(sp)}" target="_blank">Report an issue with this clue</a>
        </div>
      </div>
    `;

    document.getElementById('next-btn').addEventListener('click', () => {
      currentIndex++;
      if (currentIndex >= speeches.length) {
        showSummary();
      } else {
        guessesUsed = 0;
        hintsUsed = 0;
        hintShown = false;
        roundOver = false;
        renderGame();
      }
    });

    updateScoreBar();
  }

  function getGrade(score, maxScore) {
    const pct = maxScore > 0 ? (score / maxScore) * 100 : 0;
    if (pct === 100) return "Standing ovation \u2014 the orchestra wouldn\u2019t dare play you off";
    if (pct >= 80)  return "Tearful thank-you to your agent, your mother, and the Academy";
    if (pct >= 60)  return "Thanked your publicist, your lawyer, three producers, two casting directors, and a caterer";
    if (pct >= 40)  return "Forgot to thank your spouse";
    if (pct >= 20)  return "Played off by the orchestra mid-sentence";
    return "Tripped on the stairs walking up to the stage";
  }

  function showSummary() {
    document.getElementById('game').style.display = 'none';
    const maxScore = speeches.length * 10;
    const correctCount = results.filter(r => r.correct).length;

    let breakdownHtml = results.map(r => `
      <div>
        <span>${escapeHtml(r.speech.film_title)} (${r.speech.year})</span>
        <span>+${r.points}</span>
      </div>
    `).join('');

    const grade = getGrade(score, maxScore);

    const summaryEl = document.getElementById('summary');
    summaryEl.style.display = 'block';
    summaryEl.innerHTML = `
      <div class="summary">
        <h2>Game Over</h2>
        <div class="final-score">${score} / ${maxScore}</div>
        <div style="margin-top:12px; color:#d4af37; font-style:italic; font-size:1.1rem">
          ${escapeHtml(grade)}
        </div>
        <div style="margin-top:6px; color:#aaa">
          ${correctCount} of ${speeches.length} correct
        </div>
        <div class="card breakdown" style="margin-top:24px">
          ${breakdownHtml}
        </div>
        <button class="btn-primary" style="margin-top:24px" onclick="location.reload()">
          Play Again
        </button>
      </div>
    `;
  }

  function showStart() {
    document.getElementById('start').style.display = 'block';
    document.getElementById('start').innerHTML = `
      <div class="start-screen">
        <h2>How to Play</h2>
        <div class="rules">
          <p><strong>Goal:</strong> Read a snippet from an Oscar acceptance speech and guess the movie and category. 5 rounds total.</p>
          <p><strong>Scoring:</strong> 10 points per speech. Each hint or wrong guess costs 2 points. You get 3 guesses per round.</p>
          <p><strong>Hints:</strong> Two available â€” a list of possible films, and a cryptic plot clue.</p>
          <p>Spot an error? You can report it after each round.</p>
        </div>
        <button class="btn-primary" id="start-btn" style="max-width:200px">Start Game</button>
      </div>
    `;
    document.getElementById('start-btn').addEventListener('click', () => {
      document.getElementById('start').style.display = 'none';
      document.getElementById('game').style.display = 'block';
      renderGame();
    });
  }

  // Init
  fetch('data.json')
    .then(r => r.json())
    .then(d => {
      data = d;
      speeches = shuffle([...d.speeches]).slice(0, GAME_SIZE);
      document.getElementById('loading').style.display = 'none';
      showStart();
    })
    .catch(err => {
      document.getElementById('loading').textContent =
        'Failed to load data.json. Run export_game_data.py first.';
      console.error(err);
    });
})();
</script>
</body>
</html>
